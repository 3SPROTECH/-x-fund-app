<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>X-Fund - Dossier de Financement Plein Écran</title>
<style>
  :root {
    --primary: #111827;        /* Onyx */
    --primary-light: #D4AF37;  /* Or */
    --primary-hover: #000000;  /* Noir pur */
    --gray-light: #e5e7eb;    
    --gray-text: #6b7280;
    --white: #ffffff;
    --bg-color: #f3f4f6;
    --input-border: #d1d5db;
    --transition: all 0.3s ease;
    --danger: #ef4444;
  }

  body {
    font-family: system-ui, -apple-system, sans-serif;
    background-color: var(--bg-color);
    margin: 0;
    height: 100vh;
    overflow: hidden;
  }

  .app-container {
    display: flex;
    flex-direction: column;
    width: 100vw;
    height: 100vh;
    background: var(--white);
  }

  /* ==================== MACRO NAV ==================== */
  .macro-nav {
    display: flex;
    background: #fafafa;
    border-bottom: 2px solid var(--gray-light);
    padding: 0 40px;
    flex-shrink: 0;
  }

  .macro-step {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px 10px;
    gap: 8px;
    color: var(--gray-text);
    font-size: 14px;
    font-weight: 500;
    position: relative;
    text-align: center;
    cursor: pointer;
  }

  .macro-step-icon {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    border: 2px solid var(--gray-text);
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 12px;
    font-weight: bold;
    transition: var(--transition);
  }

  .macro-step.active { color: var(--primary); font-weight: 700; }
  .macro-step.active .macro-step-icon { border-color: var(--primary-light); background: var(--primary-light); color: var(--primary); }
  .macro-step.completed { color: var(--primary); }
  .macro-step.completed .macro-step-icon { border-color: var(--primary); background: var(--primary); color: var(--white); }

  /* ==================== CONTENU PRINCIPAL ==================== */
  .main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    padding: 30px 60px;
    max-width: 1200px;
    margin: 0 auto;
    width: 100%;
    box-sizing: border-box;
  }

  .micro-nav { margin-bottom: 20px; flex-shrink: 0; }
  .micro-tabs { display: flex; gap: 8px; }
  .micro-tab { flex: 1; height: 5px; background: var(--gray-light); border-radius: 4px; transition: var(--transition); }
  .micro-tab.completed { background: var(--primary); }
  .micro-tab.active { background: var(--primary-light); }
  
  .micro-status-text { margin-top: 10px; font-size: 13px; color: var(--gray-text); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }

  .form-header { margin-bottom: 25px; flex-shrink: 0; }
  .form-header h2 { margin: 0 0 5px 0; color: var(--primary); font-size: 26px; }
  .form-header p { margin: 0; color: var(--gray-text); font-size: 15px; }

  /* ==================== ZONE SCROLLABLE ==================== */
  #dynamic-fields {
    flex: 1;
    overflow-y: auto;
    padding-right: 20px;
  }

  #dynamic-fields::-webkit-scrollbar { width: 8px; }
  #dynamic-fields::-webkit-scrollbar-track { background: var(--gray-light); border-radius: 4px; }
  #dynamic-fields::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 4px; }
  #dynamic-fields::-webkit-scrollbar-thumb:hover { background: var(--primary); }

  /* Styles des Champs */
  .form-section-title { color: var(--primary); margin: 30px 0 15px 0; padding-bottom: 8px; border-bottom: 1px solid var(--gray-light); font-size: 18px; }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 20px; }
  .form-grid.full { grid-template-columns: 1fr; }
  .form-group { display: flex; flex-direction: column; }
  .form-group label { font-size: 14px; font-weight: 600; color: var(--primary); margin-bottom: 8px; }
  .form-group input, .form-group select, .form-group textarea {
    padding: 14px 16px; border: 1px solid var(--input-border); border-radius: 8px; font-size: 15px; background: #fafafa; transition: var(--transition); font-family: inherit;
  }
  .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
    outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(17, 24, 39, 0.1); background: var(--white);
  }

  .checkbox-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; background: #fafafa; padding: 16px; border-radius: 8px; border: 1px solid var(--input-border); }
  .checkbox-grid label { display: flex; align-items: center; gap: 10px; font-weight: 500; font-size: 14px; color: var(--primary); cursor: pointer; margin: 0; }
  .checkbox-grid input[type="checkbox"], .checkbox-grid input[type="radio"] { width: 18px; height: 18px; accent-color: var(--primary-light); cursor: pointer; margin: 0; }

  /* Read-only Header */
  .readonly-header { background-color: #f8fafc; border: 1px solid var(--gray-light); border-radius: 8px; padding: 16px 20px; margin-bottom: 24px; display: flex; align-items: center; gap: 12px; }
  .readonly-header h3 { margin: 0; color: var(--primary); font-size: 18px; font-weight: 600; }

  /* ==================== ACCORDION LEDGER (STEP 2.2) ==================== */
  .ledger-card {
      background: var(--white);
      border: 1px solid var(--gray-light);
      border-radius: 8px;
      margin-bottom: 16px;
      overflow: hidden;
  }

  .ledger-card summary {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: #fafafa;
      cursor: pointer;
      font-weight: 600;
      color: var(--primary);
      font-size: 16px;
      list-style: none;
      border-bottom: 1px solid transparent;
      transition: var(--transition);
  }
  
  .ledger-card summary::-webkit-details-marker { display: none; }
  .ledger-card[open] summary { border-bottom-color: var(--gray-light); background: var(--white); }
  
  .ledger-title { display: flex; align-items: center; gap: 10px; }
  .ledger-subtotal { font-family: monospace; font-size: 16px; background: var(--primary-light); color: var(--primary); padding: 4px 12px; border-radius: 20px; font-weight: 700;}

  .ledger-content { padding: 24px 20px; }
  
  /* Lignes de coûts simplifiées (plus d'inputs désactivés) */
  .cost-row { display: flex; gap: 16px; align-items: center; margin-bottom: 16px; }
  .cost-row .label-col { flex: 1; font-weight: 500; color: var(--primary); font-size: 15px; }
  .cost-row .amount-col { flex: 0 0 200px; }
  .cost-row .form-group { margin-bottom: 0; }
  
  /* Bouton Upload Document Justificatif */
  .file-upload-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--white);
      border: 1px dashed var(--input-border);
      color: var(--gray-text);
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: var(--transition);
      height: 48px;
      box-sizing: border-box;
      white-space: nowrap;
      flex-shrink: 0;
  }
  .file-upload-btn:hover { border-color: var(--primary); color: var(--primary); background: #f8fafc; }
  .file-upload-btn input[type="file"] { display: none; }
  
  /* Bouton Poubelle (Icon uniquement) */
  .icon-btn {
      display: flex; align-items: center; justify-content: center;
      width: 48px; height: 48px; border-radius: 6px; cursor: pointer;
      transition: var(--transition); flex-shrink: 0; background: var(--white);
      border: 1px solid var(--input-border); color: var(--gray-text);
  }
  .icon-btn:hover { background: var(--gray-light); }
  .icon-btn.btn-remove { border-color: #fca5a5; color: var(--danger); background: #fef2f2; }
  .icon-btn.btn-remove:hover { background: #fee2e2; border-color: var(--danger); }

  .action-btn-text {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 10px 16px; background: var(--white); border: 1px dashed var(--gray-text);
      border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;
      color: var(--primary); transition: var(--transition);
  }
  .action-btn-text:hover { background: #f8fafc; border-color: var(--primary); color: var(--primary); }

  /* ==================== LOT GALLERY (STEP 2.3) ==================== */
  .lots-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      gap: 12px;
      flex-wrap: wrap;
  }
  .lots-meta { color: var(--gray-text); font-size: 13px; font-weight: 500; }
  .lot-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-bottom: 20px;
  }
  .lot-card {
      border: 1px solid var(--gray-light);
      border-radius: 10px;
      background: #fcfcfd;
      overflow: hidden;
      display: flex;
      flex-direction: column;
  }
  .lot-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      background: var(--white);
      border-bottom: 1px solid var(--gray-light);
  }
  .lot-card-title { font-weight: 700; color: var(--primary); font-size: 15px; }
  .lot-card-summary { color: var(--gray-text); font-size: 12px; margin-top: 3px; }
  .lot-card-body { padding: 16px; display: grid; gap: 12px; }
  .readonly-chip {
      background: #f3f4f6;
      border: 1px solid var(--gray-light);
      border-radius: 8px;
      padding: 12px 14px;
      color: var(--primary);
      font-weight: 700;
      font-family: monospace;
      font-size: 15px;
  }
  .readonly-chip small {
      display: block;
      color: var(--gray-text);
      font-family: inherit;
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
  }

  /* ==================== VERIFICATION DASHBOARD (STEP 2.4) ==================== */
  .trust-dashboard {
      background: #f8fafc;
      border: 1px solid var(--gray-light);
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 18px;
      display: grid;
      grid-template-columns: repeat(3, minmax(120px, 1fr));
      gap: 12px;
  }
  .trust-kpi {
      background: var(--white);
      border: 1px solid var(--gray-light);
      border-radius: 8px;
      padding: 12px;
  }
  .trust-kpi-label {
      font-size: 12px;
      color: var(--gray-text);
      text-transform: uppercase;
      letter-spacing: 0.4px;
      font-weight: 700;
  }
  .trust-kpi-value {
      margin-top: 6px;
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
      font-family: monospace;
  }
  .doc-group {
      margin-bottom: 20px;
      border: 1px solid var(--gray-light);
      border-radius: 10px;
      overflow: hidden;
      background: var(--white);
  }
  .doc-group-title {
      margin: 0;
      padding: 12px 16px;
      border-bottom: 1px solid var(--gray-light);
      background: #fafafa;
      color: var(--primary);
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
  }
  .doc-list { padding: 10px 12px; }
  .doc-row {
      border: 1px solid var(--gray-light);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      transition: var(--transition);
  }
  .doc-row:last-child { margin-bottom: 0; }
  .doc-row.status-empty { background: #ffffff; border-color: var(--gray-light); }
  .doc-row.status-uploaded { background: #f0fdf4; border-color: #86efac; }
  .doc-row.status-commented { background: #fefce8; border-color: #fde047; }
  .doc-row-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
      flex-wrap: wrap;
  }
  .doc-title { font-weight: 600; color: var(--primary); }
  .doc-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-text);
  }
  .doc-status-icon {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #f3f4f6;
      color: var(--gray-text);
  }
  .doc-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
  }
  .doc-comment-toggle {
      border: none;
      background: transparent;
      color: var(--primary);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: underline;
      padding: 0;
  }
  .doc-file-name {
      font-size: 12px;
      color: var(--gray-text);
      font-style: italic;
  }
  .doc-comment-box {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed var(--input-border);
  }

  /* ==================== PROPERTY HUB (STEP 2.0) ==================== */
  .hub-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
  }
  .hub-list {
      display: grid;
      gap: 14px;
      margin-bottom: 16px;
  }
  .hub-card {
      border: 1px solid var(--gray-light);
      background: #fcfcfd;
      border-radius: 10px;
      padding: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
  }
  .hub-card.complete { border-color: #86efac; background: #f0fdf4; }
  .hub-card.incomplete { border-color: #fde68a; background: #fffbeb; }
  .hub-card-title { font-weight: 700; color: var(--primary); }
  .hub-card-subtitle { font-size: 12px; color: var(--gray-text); margin-top: 3px; }
  .hub-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.4px;
  }

  /* ==================== PROJECTIONS (STEP 3) ==================== */
  .projection-power-card {
      background: linear-gradient(135deg, #0f172a 0%, #111827 100%);
      border: 1px solid rgba(212, 175, 55, 0.35);
      border-radius: 12px;
      padding: 22px;
      box-shadow: 0 12px 28px rgba(0,0,0,0.2);
      margin-bottom: 18px;
  }
  .projection-power-label {
      color: #9ca3af;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 700;
  }
  .projection-power-amount {
      margin-top: 8px;
      font-size: 40px;
      font-weight: 800;
      color: var(--primary-light);
      text-shadow: 0 0 16px rgba(212, 175, 55, 0.25);
      font-family: monospace;
  }
  .projection-power-meta {
      color: #d1d5db;
      font-size: 14px;
      margin-top: 4px;
      margin-bottom: 18px;
  }
  .power-slider-wrap { margin-top: 8px; }
  .power-slider {
      width: 100%;
      appearance: none;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.14);
      outline: none;
  }
  .power-slider::-webkit-slider-thumb {
      appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--primary-light);
      border: 2px solid #fef3c7;
      cursor: pointer;
      box-shadow: 0 0 14px rgba(212, 175, 55, 0.5);
  }
  .power-slider-ends {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      color: #9ca3af;
      font-size: 12px;
      font-weight: 600;
  }
  .onyx-alert {
      background: #111827;
      border: 1px solid rgba(212, 175, 55, 0.45);
      border-radius: 10px;
      color: #f3f4f6;
      padding: 12px 14px;
      margin-bottom: 14px;
      font-size: 14px;
      font-weight: 500;
  }
  .warning-alert {
      display: none;
      align-items: flex-start;
      gap: 10px;
      background: #fef2f2;
      border: 1px solid #fca5a5;
      border-radius: 10px;
      color: #991b1b;
      padding: 12px 14px;
      margin-bottom: 14px;
      font-size: 13px;
      font-weight: 600;
  }
  .warning-alert svg {
      flex-shrink: 0;
      margin-top: 2px;
  }
  .dropzone {
      border: 2px dashed var(--input-border);
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      color: var(--gray-text);
      background: #fafafa;
      cursor: pointer;
  }
  .receipt-card {
      border: 1px solid var(--gray-light);
      border-radius: 10px;
      background: var(--white);
      padding: 10px 0;
      margin-top: 10px;
  }
  .receipt-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      transition: var(--transition);
      border-bottom: 1px solid #f1f5f9;
  }
  .receipt-row:last-child { border-bottom: none; }
  .receipt-row:hover { background: #f8fafc; }
  .receipt-key { color: var(--gray-text); font-weight: 600; }
  .receipt-val { color: var(--primary); font-weight: 700; font-family: monospace; }
  .receipt-val.gold { color: #b45309; }
  .final-payout {
      margin-top: 14px;
      border-radius: 10px;
      background: #111827;
      padding: 16px;
      color: var(--white);
      border: 1px solid rgba(212,175,55,0.35);
  }
  .final-payout-title {
      color: #9ca3af;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.45px;
      font-weight: 700;
  }
  .final-payout-value {
      margin-top: 6px;
      font-size: 32px;
      color: var(--primary-light);
      font-weight: 800;
      font-family: monospace;
  }

  /* Floating Total Bar - Fixée structurellement sans Absolute */
  #floating-total-container {
      flex-shrink: 0;
      padding-top: 20px;
      border-top: 1px solid var(--gray-light);
      background: var(--white);
      margin-right: 20px; /* Aligné avec le scrollbar */
  }
  .floating-total-bar {
      background: var(--primary);
      color: var(--white);
      padding: 16px 24px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 24px; /* Espacement avant le footer */
  }
  .floating-total-label { font-size: 15px; font-weight: 500; color: #9ca3af;}
  .floating-total-value { font-size: 24px; font-weight: 700; color: var(--primary-light); font-family: monospace;}
  .floating-total-separator { width: 1px; height: 40px; background: rgba(255,255,255,0.15); margin: 0 14px; }
  .floating-total-block { display: flex; flex-direction: column; gap: 4px; }
  .floating-total-value.alt { color: #ffffff; font-size: 22px; }

  /* ==================== SUBMISSION NOTICE ==================== */
  #submission-notice-container {
      flex-shrink: 0;
      margin-right: 20px;
      margin-bottom: 12px;
  }
  .submission-notice {
      background: #ecfdf3;
      border: 1px solid #86efac;
      color: #166534;
      border-radius: 8px;
      padding: 12px 14px;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
  }

  /* ==================== FOOTER ==================== */
  .form-footer {
    display: flex;
    justify-content: space-between;
    padding-bottom: 30px;
    flex-shrink: 0;
    background: var(--white);
  }

  button.nav-btn { padding: 14px 32px; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: var(--transition); border: none; }
  .btn-prev { background: var(--white); border: 1px solid var(--input-border); color: var(--primary); }
  .btn-prev:hover:not(:disabled) { background: var(--gray-light); }
  .btn-next { background: var(--primary); color: var(--white); }
  .btn-next:hover { background: var(--primary-hover); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
  button.nav-btn:disabled { opacity: 0.4; cursor: not-allowed; }
</style>
</head>
<body>

<div class="app-container">
  <nav class="macro-nav" id="macro-nav"></nav>
  <main class="main-content">
    
    <div class="micro-nav">
      <div class="micro-tabs" id="micro-tabs"></div>
      <div class="micro-status-text" id="micro-status-text">Partie 1 sur 4</div>
    </div>

    <div class="form-header">
      <h2 id="step-title">Titre de l'étape</h2>
      <p id="step-desc">Description de la sous-étape</p>
    </div>
      
    <div id="dynamic-fields"></div>
    
    <div id="floating-total-container"></div>
    <div id="submission-notice-container"></div>

    <footer class="form-footer">
      <button class="nav-btn btn-prev" id="btn-prev" disabled>Retour</button>
      <button class="nav-btn btn-next" id="btn-next">Étape Suivante</button>
    </footer>

  </main>
</div>

<script>
  // Dictionnaire d'icônes SVG professionnels (Feather Icons)
  const icons = {
      pin: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--primary-light)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>`,
      building: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><path d="M9 22v-4h6v4"></path><path d="M8 6h.01"></path><path d="M16 6h.01"></path><path d="M12 6h.01"></path><path d="M12 10h.01"></path><path d="M12 14h.01"></path><path d="M16 10h.01"></path><path d="M16 14h.01"></path><path d="M8 10h.01"></path><path d="M8 14h.01"></path></svg>`,
      tool: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>`,
      ruler: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.16 3.84a2.78 2.78 0 0 0-3.92 0l-14.4 14.4a2.78 2.78 0 0 0 3.92 3.92l14.4-14.4a2.78 2.78 0 0 0 0-3.92z"></path><path d="M17.24 7.76l-3.92-3.92"></path><path d="M12.92 12.08l-3.92-3.92"></path><path d="M8.6 16.4l-3.92-3.92"></path></svg>`,
      plus: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`,
      paperclip: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>`,
      trash: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`,
      check: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`,
      info: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>`,
      alert: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.3" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86l-8 13.86a2 2 0 0 0 1.73 3h16a2 2 0 0 0 1.73-3l-8-13.86a2 2 0 0 0-3.46 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>`
  };

  window.calculateEquity = function() {
    const valBefore = parseFloat(document.getElementById('valBefore')?.value) || 0;
    const valAfter = parseFloat(document.getElementById('valAfter')?.value) || 0;
    const equityContainer = document.getElementById('equity-container');
    const equityResult = document.getElementById('equity-result');

    if (equityContainer && valBefore > 0 && valAfter > 0) {
      const bump = valAfter - valBefore;
      equityContainer.style.display = 'block';
      if (bump > 0) {
        equityContainer.style.background = '#f0fdf4';
        equityContainer.style.borderColor = '#bbf7d0';
        equityResult.style.color = '#15803d';
        equityResult.innerText = `↗ Plus-value brute estimée : +${bump.toLocaleString('fr-FR')} €`;
      } else {
        equityContainer.style.background = '#fef2f2';
        equityContainer.style.borderColor = '#fecaca';
        equityResult.style.color = '#b91c1c';
        equityResult.innerText = `↘ Perte/Déficit estimé : ${bump.toLocaleString('fr-FR')} €`;
      }
    } else if (equityContainer) {
      equityContainer.style.display = 'none';
    }
  };

  window.toggleRenovationDuration = function() {
      const radioOui = document.getElementById('renov-oui');
      const durationContainer = document.getElementById('renov-duration-container');
      if(radioOui && durationContainer) durationContainer.style.display = radioOui.checked ? 'grid' : 'none';
  };

  window.toggleOwnershipDate = function() {
      const radioOuiProprio = document.getElementById('proprio-oui');
      const dateContainer = document.getElementById('date-signature-container');
      if(radioOuiProprio && dateContainer) dateContainer.style.display = radioOuiProprio.checked ? 'none' : 'grid';
  };

  function formatCurrency(amount) {
      return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount);
  }

  window.calculateNotaryFees = function() {
      const acqInput = document.querySelector('.cost-input[data-category="acq"][data-id="acq-price"]');
      const notaryInput = document.querySelector('.cost-input[data-category="acq"][data-id="acq-notary"]');
      if(acqInput && notaryInput) {
          const val = parseFloat(acqInput.value) || 0;
          if(val > 0) notaryInput.value = Math.round(val * 0.075); 
          else notaryInput.value = '';
          window.updateLedgerTotals();
      }
  }

  window.updateLedgerTotals = function() {
      let grandTotal = 0;
      const categories = ['acq', 'travaux', 'expert', 'custom'];
      
      categories.forEach(cat => {
          let catTotal = 0;
          document.querySelectorAll(`.cost-input[data-category="${cat}"]`).forEach(input => {
              catTotal += parseFloat(input.value) || 0;
          });
          grandTotal += catTotal;
          const subtotalEl = document.getElementById(`subtotal-${cat}`);
          if(subtotalEl) subtotalEl.innerText = formatCurrency(catTotal);
      });
      
      const grandTotalEl = document.getElementById('ledger-grand-total');
      if(grandTotalEl) grandTotalEl.innerText = formatCurrency(grandTotal);
      window.lastLedgerGrandTotal = grandTotal;
      const asset = getCurrentAsset();
      if (asset) asset.costTotal = grandTotal;
      updateRecettesSummaryBar();
  }

  const PRICE_PER_M2 = 2130;
  let lotIdCounter = 1;
  let assetIdCounter = 1;
  let selectedAssetIndex = null;
  let projectPrimaryAddress = '';
  let lastSyncedPrimaryAddress = '';
  let lotsState = [];
  let assetsState = [];
  let dossierSubmitting = false;
  let dossierSubmitted = false;
  const DOSSIER_SUBMIT_STEP_INDEX = 10;
  window.lastLedgerGrandTotal = 0;

  function shouldLockEditing() {
      return dossierSubmitting || dossierSubmitted;
  }

  function renderSubmissionNotice() {
      const noticeEl = document.getElementById('submission-notice-container');
      if (!noticeEl) return;
      if (!dossierSubmitted) {
          noticeEl.innerHTML = '';
          return;
      }
      noticeEl.innerHTML = `
        <div class="submission-notice">
          ${icons.check}
          Votre dossier est envoyé. Notre équipe l'analyse actuellement. Merci de patienter.
        </div>
      `;
  }

  function applyReadOnlyMode() {
      if (!shouldLockEditing()) return;
      dynamicFieldsEl.querySelectorAll('input, select, textarea, button').forEach(el => {
          if (el.id === 'btn-prev' || el.id === 'btn-next') return;
          if (el.classList && el.classList.contains('allow-readonly-nav')) return;
          if (el.tagName === 'INPUT' && (el.type === 'file' || el.type === 'range' || el.type === 'number' || el.type === 'text' || el.type === 'date' || el.type === 'url' || el.type === 'checkbox' || el.type === 'radio')) {
              el.disabled = true;
              return;
          }
          if (el.tagName === 'SELECT' || el.tagName === 'TEXTAREA' || el.tagName === 'BUTTON') {
              el.disabled = true;
          }
      });
  }

  function cloneDeep(obj) {
      return JSON.parse(JSON.stringify(obj));
  }

  function createDefaultVerificationDocsState() {
      return verificationDocBlueprint.map(item => ({
          ...item,
          fileName: '',
          comment: '',
          showComment: false
      }));
  }

  function createEmptyAsset(initialLabel = '') {
      const id = assetIdCounter++;
      const resolvedLabel = (initialLabel || '').trim() || `Adresse ${id}`;
      return {
          id,
          label: resolvedLabel,
          detailsFields: {},
          costsFields: {},
          lots: [createEmptyLot()],
          verificationDocs: createDefaultVerificationDocsState(),
          costTotal: 0,
          recettesTotal: 0,
          completed: false
      };
  }

  function getCurrentAsset() {
      if (selectedAssetIndex === null || selectedAssetIndex < 0 || selectedAssetIndex >= assetsState.length) return null;
      return assetsState[selectedAssetIndex];
  }

  function computeAssetRecettesTotal(asset) {
      const lots = asset?.lots || [];
      return lots.reduce((sum, lot) => sum + calcProjectedPrice(lot), 0);
  }

  function areRequiredDocsSatisfied(asset) {
      const docs = asset?.verificationDocs || [];
      return docs.filter(doc => doc.required).every(doc => getDocStatus(doc) !== 'empty');
  }

  function isAssetComplete(asset) {
      if (!asset) return false;
      const hasLots = (asset.lots || []).length > 0;
      const hasDocs = areRequiredDocsSatisfied(asset);
      return hasLots && hasDocs;
  }

  function saveAssetStepData() {
      const asset = getCurrentAsset();
      if (!asset) return;

      if (globalStepIndex === 5) {
          const fields = {};
          dynamicFieldsEl.querySelectorAll('input, select, textarea').forEach((el, idx) => {
              const key = el.id || el.name || `f-${idx}`;
              if (el.type === 'checkbox' || el.type === 'radio') fields[key] = el.checked;
              else fields[key] = el.value;
          });
          asset.detailsFields = fields;
      } else if (globalStepIndex === 6) {
          const fields = {};
          dynamicFieldsEl.querySelectorAll('input[type="text"], input[type="number"], select, textarea').forEach((el, idx) => {
              const key = el.id || el.name || `f-${idx}`;
              fields[key] = el.value;
          });
          const readRows = (category) => {
              return Array.from(document.querySelectorAll(`#list-${category} .cost-row`)).map(row => ({
                  label: row.querySelector('.label-col input')?.value || '',
                  amount: row.querySelector('.cost-input')?.value || ''
              }));
          };
          asset.costsFields = fields;
          asset.costRows = {
              travaux: readRows('travaux'),
              custom: readRows('custom')
          };
          asset.costTotal = window.lastLedgerGrandTotal || 0;
      } else if (globalStepIndex === 7) {
          asset.lots = cloneDeep(lotsState);
          asset.recettesTotal = computeAssetRecettesTotal(asset);
      } else if (globalStepIndex === 8) {
          asset.verificationDocs = cloneDeep(verificationDocsState);
      }

      asset.completed = isAssetComplete(asset);
  }

  function applyStoredFormValues(fieldMap) {
      if (!fieldMap) return;
      dynamicFieldsEl.querySelectorAll('input, select, textarea').forEach((el, idx) => {
          const key = el.id || el.name || `f-${idx}`;
          if (!(key in fieldMap)) return;
          if (el.type === 'checkbox' || el.type === 'radio') el.checked = !!fieldMap[key];
          else el.value = fieldMap[key] ?? '';
      });
  }

  function updateHubCards() {
      const list = document.getElementById('hub-list');
      const countEl = document.getElementById('hub-count');
      if (!list) return;
      if (countEl) countEl.innerText = `${assetsState.length} adresse${assetsState.length > 1 ? 's' : ''}`;

      list.innerHTML = assetsState.map((asset, idx) => {
          const completed = isAssetComplete(asset);
          return `
            <article class="hub-card ${completed ? 'complete' : 'incomplete'}">
              <div>
                <div class="form-group" style="margin:0;">
                  <label style="margin-bottom:6px;">Nom de l'adresse</label>
                  <input type="text" value="${escapeHtml(asset.label)}" placeholder="Ex: 12 Rue Victor Hugo, Paris" oninput="updateAssetLabel(${idx}, this.value)">
                </div>
                <div class="hub-card-subtitle">Actif #${idx + 1}</div>
              </div>
              <div style="display:flex; align-items:center; gap:12px;">
                <span class="hub-status">${completed ? icons.check : icons.info} ${completed ? 'Complet' : 'Incomplet'}</span>
                <button class="nav-btn btn-next allow-readonly-nav" type="button" onclick="openAssetSubFlow(${idx})">Ouvrir</button>
              </div>
            </article>
          `;
      }).join('');
  }

  window.addNewAsset = function() {
      assetsState.push(createEmptyAsset());
      updateHubCards();
      updateUI();
  }

  window.openAssetSubFlow = function(idx) {
      selectedAssetIndex = idx;
      globalStepIndex = 5;
      updateUI();
  }

  window.updateAssetLabel = function(idx, value) {
      const asset = assetsState[idx];
      if (!asset) return;
      asset.label = value || `Adresse ${asset.id}`;
  }

  function getAggregateFinancials() {
      return assetsState.reduce((acc, asset) => {
          const cost = asset.costTotal || 0;
          const recettes = computeAssetRecettesTotal(asset);
          acc.cost += cost;
          acc.recettes += recettes;
          return acc;
      }, { cost: 0, recettes: 0, profit: 0 });
  }

  const projectionState = {
      contributionPct: 20,
      durationMonths: 12,
      proofFileName: ''
  };

  function getProjectionTotals() {
      const totals = getAggregateFinancials();
      const totalCosts = totals.cost;
      const contributionPct = Math.max(0, Math.min(100, parseNum(projectionState.contributionPct)));
      const apport = totalCosts * (contributionPct / 100);
      const base = Math.max(0, totalCosts - apport);
      const duration = Math.max(1, parseNum(projectionState.durationMonths) || 12);
      const reserveRate = (0.11 / 12) * duration;
      const denominator = 1 - 0.06 - reserveRate;
      const totalCollecte = denominator > 0 ? (base / denominator) : 0;
      const platformFee = totalCollecte * 0.06;
      const interestReserve = totalCollecte * reserveRate;
      const montantReverse = totalCollecte - platformFee - interestReserve;
      return { totalCosts, contributionPct, apport, duration, totalCollecte, platformFee, interestReserve, montantReverse };
  }

  function refreshContributionUI() {
      const t = getProjectionTotals();
      const aggregate = getAggregateFinancials();
      const resaleAmount = aggregate.recettes;
      const base = t.totalCosts - t.apport;
      const ratio = base > 0 ? (resaleAmount / base) : 999;
      const amountEl = document.getElementById('contribution-amount');
      const pctEl = document.getElementById('contribution-pct');
      const sliderEl = document.getElementById('contribution-slider');
      const fileEl = document.getElementById('proof-file-name');
      const warningEl = document.getElementById('projection-warning');
      const warningRatioEl = document.getElementById('projection-warning-ratio');
      if (amountEl) amountEl.innerText = formatCurrency(t.apport);
      if (pctEl) pctEl.innerText = `${Math.round(t.contributionPct)}% du coût total agrégé (${formatCurrency(t.totalCosts)})`;
      if (sliderEl) sliderEl.value = String(t.contributionPct);
      if (fileEl) fileEl.innerText = projectionState.proofFileName ? `Fichier: ${projectionState.proofFileName}` : '';
      if (warningEl) warningEl.style.display = ratio < 1 ? 'flex' : 'none';
      if (warningRatioEl) warningRatioEl.innerText = ratio.toFixed(2);
  }

  function refreshSimulationUI() {
      const t = getProjectionTotals();
      const durationEl = document.getElementById('projection-duration');
      if (durationEl) durationEl.value = String(t.duration);
      const setText = (id, value) => {
          const el = document.getElementById(id);
          if (el) el.innerText = value;
      };
      setText('sim-total-costs', formatCurrency(t.totalCosts));
      setText('sim-apport', formatCurrency(t.apport));
      setText('sim-fee', formatCurrency(t.platformFee));
      setText('sim-interest', formatCurrency(t.interestReserve));
      setText('sim-collecte', formatCurrency(t.totalCollecte));
      setText('sim-payout', formatCurrency(t.montantReverse));
  }

  window.updateContributionPct = function(value) {
      projectionState.contributionPct = parseNum(value);
      refreshContributionUI();
      refreshSimulationUI();
  }

  window.updateProjectionDuration = function(value) {
      projectionState.durationMonths = parseNum(value) || 12;
      refreshSimulationUI();
  }

  window.handleProofUpload = function(inputEl) {
      projectionState.proofFileName = inputEl?.files?.[0]?.name || '';
      refreshContributionUI();
  }

  function saveProjectLevelData() {
      if (globalStepIndex === 1) {
          const addressInput = document.getElementById('project-main-address');
          if (addressInput) projectPrimaryAddress = (addressInput.value || '').trim();
      }
  }

  function syncPrimaryAddressToFirstAsset() {
      if (assetsState.length === 0 || !projectPrimaryAddress) return;
      const firstAsset = assetsState[0];
      const genericLabel = /^Adresse \d+$/.test(firstAsset.label || '');
      const previouslySynced = !!lastSyncedPrimaryAddress && firstAsset.label === lastSyncedPrimaryAddress;
      if (genericLabel || previouslySynced || !firstAsset.label) {
          firstAsset.label = projectPrimaryAddress;
          lastSyncedPrimaryAddress = projectPrimaryAddress;
      }
  }

  function createEmptyLot() {
      return { id: lotIdCounter++, precommercialise: 'non', loue: 'non', superficie: '', prix: '', promesseRef: '', bailRef: '' };
  }

  function parseNum(v) {
      const n = parseFloat(v);
      return Number.isFinite(n) ? n : 0;
  }

  function calcPrixM2(lot) {
      if (lot.precommercialise === 'oui' || lot.loue === 'oui') return 0;
      const superficie = parseNum(lot.superficie);
      if (superficie <= 0) return 0;
      return PRICE_PER_M2;
  }

  function calcProjectedPrice(lot) {
      if (lot.precommercialise === 'oui' || lot.loue === 'oui') return 0;
      const superficie = parseNum(lot.superficie);
      if (superficie <= 0) return 0;
      return Math.round(superficie * PRICE_PER_M2);
  }

  function normalizeLotCalculatedValues() {
      lotsState.forEach(lot => {
          lot.prix = calcProjectedPrice(lot);
      });
  }

  function getTotalRecettes() {
      return lotsState.reduce((sum, lot) => sum + parseNum(lot.prix), 0);
  }

  window.addLotCard = function() {
      lotsState.push(createEmptyLot());
      const asset = getCurrentAsset();
      if (asset) asset.lots = cloneDeep(lotsState);
      renderLots();
      updateRecettesSummaryBar();
  }

  window.removeLotCard = function(id) {
      lotsState = lotsState.filter(lot => lot.id !== id);
      if (lotsState.length === 0) lotsState.push(createEmptyLot());
      const asset = getCurrentAsset();
      if (asset) asset.lots = cloneDeep(lotsState);
      renderLots();
      updateRecettesSummaryBar();
  }

  window.updateLotField = function(id, field, value) {
      const lot = lotsState.find(item => item.id === id);
      if (!lot) return;
      lot[field] = value;
      if (field === 'superficie') {
          lot.prix = calcProjectedPrice(lot);
          refreshLotCardDisplay(id);
      } else if (field === 'precommercialise' || field === 'loue') {
          renderLots();
      }
      const asset = getCurrentAsset();
      if (asset) asset.lots = cloneDeep(lotsState);
      updateRecettesSummaryBar();
  }

  function refreshLotCardDisplay(id) {
      const lot = lotsState.find(item => item.id === id);
      if (!lot) return;

      const summaryEl = document.getElementById(`lot-summary-${id}`);
      const prixM2El = document.getElementById(`lot-prixm2-${id}`);
      const prixInputEl = document.getElementById(`lot-prix-${id}`);
      const superficie = parseNum(lot.superficie);
      const prix = calcProjectedPrice(lot);
      const prixM2 = calcPrixM2(lot);
      const showDocs = lot.precommercialise === 'oui' || lot.loue === 'oui';

      if (summaryEl) {
          summaryEl.innerText = showDocs
              ? 'Justificatifs requis'
              : `${superficie > 0 ? `${superficie} m²` : 'Superficie à définir'} · ${prix > 0 ? formatCurrency(prix) : 'Prix à définir'}`;
      }
      if (prixInputEl) {
          prixInputEl.value = prix > 0 ? Math.round(prix) : '';
      }
      if (prixM2El) {
          prixM2El.value = prixM2 > 0 ? Math.round(prixM2) : '';
      }
  }

  function renderLots() {
      const gallery = document.getElementById('lot-gallery');
      const countEl = document.getElementById('lot-count');
      if (!gallery) return;
      normalizeLotCalculatedValues();

      if (countEl) countEl.innerText = `${lotsState.length} lot${lotsState.length > 1 ? 's' : ''}`;

      gallery.innerHTML = lotsState.map((lot, index) => {
          const prixM2 = calcPrixM2(lot);
          const isPreCommercialized = lot.precommercialise === 'oui';
          const isRented = lot.loue === 'oui';
          const showDocs = isPreCommercialized || isRented;
          const superficie = parseNum(lot.superficie);
          const prix = calcProjectedPrice(lot);
          return `
            <article class="lot-card">
              <div class="lot-card-header">
                <div>
                  <div class="lot-card-title">Lot ${index + 1}</div>
                  <div class="lot-card-summary" id="lot-summary-${lot.id}">${showDocs ? 'Justificatifs requis' : `${superficie > 0 ? `${superficie} m²` : 'Superficie à définir'} · ${prix > 0 ? formatCurrency(prix) : 'Prix à définir'}`}</div>
                </div>
                <button class="icon-btn btn-remove" type="button" title="Supprimer ce lot" onclick="removeLotCard(${lot.id})">${icons.trash}</button>
              </div>
              <div class="lot-card-body">
                <div class="form-grid">
                  <div class="form-group">
                    <label>Est-il pré-commercialisé ?</label>
                    <select onchange="updateLotField(${lot.id}, 'precommercialise', this.value)">
                      <option value="oui" ${lot.precommercialise === 'oui' ? 'selected' : ''}>Oui</option>
                      <option value="non" ${lot.precommercialise === 'non' ? 'selected' : ''}>Non</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Est-il loué ?</label>
                    <select onchange="updateLotField(${lot.id}, 'loue', this.value)">
                      <option value="oui" ${lot.loue === 'oui' ? 'selected' : ''}>Oui</option>
                      <option value="non" ${lot.loue === 'non' ? 'selected' : ''}>Non</option>
                    </select>
                  </div>
                </div>
                ${showDocs ? `
                <div class="form-grid full">
                  <div class="form-group">
                    <label>Documents justificatifs</label>
                  </div>
                </div>
                ` : ''}
                ${isPreCommercialized ? `
                <div class="form-grid">
                  <div class="form-group">
                    <label>Promesse de vente (référence)</label>
                    <input type="text" value="${lot.promesseRef || ''}" placeholder="Référence du document" oninput="updateLotField(${lot.id}, 'promesseRef', this.value)">
                  </div>
                  <div class="form-group">
                    <label>Fichier promesse de vente</label>
                    <input type="file">
                  </div>
                </div>
                ` : ''}
                ${isRented ? `
                <div class="form-grid">
                  <div class="form-group">
                    <label>Bail (référence)</label>
                    <input type="text" value="${lot.bailRef || ''}" placeholder="Référence du bail" oninput="updateLotField(${lot.id}, 'bailRef', this.value)">
                  </div>
                  <div class="form-group">
                    <label>Fichier bail</label>
                    <input type="file">
                  </div>
                </div>
                ` : ''}
                ${!showDocs ? `
                <div class="form-grid">
                  <div class="form-group">
                    <label>Superficie habitable (m²)</label>
                    <input type="number" min="0" step="0.1" value="${lot.superficie}" placeholder="Ex: 64" oninput="updateLotField(${lot.id}, 'superficie', this.value)">
                  </div>
                  <div class="form-group">
                    <label>Prix projeté de revente (€)</label>
                    <input id="lot-prix-${lot.id}" type="number" min="0" step="1" value="${prix > 0 ? Math.round(prix) : ''}" placeholder="Calculé automatiquement" disabled>
                  </div>
                </div>
                <div class="form-grid full">
                  <div class="form-group">
                    <label>Prix au m² (€)</label>
                    <input id="lot-prixm2-${lot.id}" type="number" value="${prixM2 > 0 ? Math.round(prixM2) : ''}" placeholder="Calculé automatiquement" disabled>
                  </div>
                </div>
                ` : ''}
              </div>
            </article>
          `;
      }).join('');
  }

  function updateRecettesSummaryBar() {
      const totalRecettes = getTotalRecettes();
      const bilan = totalRecettes - (window.lastLedgerGrandTotal || 0);
      const asset = getCurrentAsset();
      if (asset) asset.recettesTotal = totalRecettes;

      const recettesEl = document.getElementById('recettes-grand-total');
      if (recettesEl) recettesEl.innerText = formatCurrency(totalRecettes);
      const bilanEl = document.getElementById('projected-profit');
      if (bilanEl) bilanEl.innerText = formatCurrency(bilan);
  }

  const verificationDocBlueprint = [
      { key: 'expertise', label: "Rapport d'expertise / avis de valeur", required: true },
      { key: 'pua', label: "PUA (Promesse Unilatérale d'Achat)", required: true },
      { key: 'permis-admin', label: "Permis administratif validé", required: true },
      { key: 'business-plan', label: "Prévisions financières / Business Plan", required: true },
      { key: 'permis-construire', label: "Permis d'aménager / construire", required: false }
  ];
  let verificationDocsState = [];

  function initVerificationDocsState() {
      const asset = getCurrentAsset();
      if (!asset) {
          verificationDocsState = createDefaultVerificationDocsState();
          return;
      }
      if (!asset.verificationDocs || asset.verificationDocs.length === 0) {
          asset.verificationDocs = createDefaultVerificationDocsState();
      }
      verificationDocsState = cloneDeep(asset.verificationDocs);
  }

  function getDocByKey(key) {
      return verificationDocsState.find(item => item.key === key);
  }

  function getDocStatus(doc) {
      if (doc.fileName) return 'uploaded';
      if ((doc.comment || '').trim().length > 0) return 'commented';
      return 'empty';
  }

  function escapeHtml(value) {
      return String(value || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
  }

  function getDocStatusMeta(status) {
      if (status === 'uploaded') return { label: 'Document chargé', icon: icons.check };
      if (status === 'commented') return { label: 'Justification à analyser', icon: icons.info };
      return { label: 'À fournir', icon: '•' };
  }

  function renderDocRows(items) {
      return items.map(doc => {
          const status = getDocStatus(doc);
          const statusMeta = getDocStatusMeta(status);
          return `
            <div class="doc-row status-${status}" id="doc-row-${doc.key}">
              <div class="doc-row-head">
                <div class="doc-title">${doc.label}</div>
                <div class="doc-status" id="doc-status-${doc.key}">
                  <span class="doc-status-icon" id="doc-status-icon-${doc.key}">${statusMeta.icon}</span>
                  <span id="doc-status-label-${doc.key}">${statusMeta.label}</span>
                </div>
              </div>
              <div class="doc-actions">
                <label class="file-upload-btn">
                  ${icons.paperclip} <span>Upload</span>
                  <input type="file" onchange="handleDocFileUpload('${doc.key}', this)">
                </label>
                <button type="button" class="doc-comment-toggle" id="doc-toggle-${doc.key}" onclick="toggleDocComment('${doc.key}')">Je n'ai pas ce document</button>
                <span class="doc-file-name" id="doc-file-${doc.key}">${doc.fileName ? escapeHtml(doc.fileName) : ''}</span>
              </div>
              <div class="doc-comment-box" id="doc-comment-box-${doc.key}" style="display: ${doc.showComment ? 'block' : 'none'};">
                <div class="form-group">
                  <label>Commentaire / justification</label>
                  <textarea rows="2" placeholder="Expliquez pourquoi ce document n'est pas encore disponible..." oninput="updateDocComment('${doc.key}', this.value)">${escapeHtml(doc.comment)}</textarea>
                </div>
              </div>
            </div>
          `;
      }).join('');
  }

  function renderVerificationChecklist() {
      initVerificationDocsState();
      const requiredContainer = document.getElementById('verification-required-list');
      const optionalContainer = document.getElementById('verification-optional-list');
      if (!requiredContainer || !optionalContainer) return;

      requiredContainer.innerHTML = renderDocRows(verificationDocsState.filter(doc => doc.required));
      optionalContainer.innerHTML = renderDocRows(verificationDocsState.filter(doc => !doc.required));
      verificationDocsState.forEach(doc => updateDocRowUI(doc.key));
      updateTrustDashboardCounters();
  }

  function updateDocRowUI(key) {
      const doc = getDocByKey(key);
      if (!doc) return;
      const status = getDocStatus(doc);
      const statusMeta = getDocStatusMeta(status);
      const rowEl = document.getElementById(`doc-row-${key}`);
      const iconEl = document.getElementById(`doc-status-icon-${key}`);
      const labelEl = document.getElementById(`doc-status-label-${key}`);
      const fileEl = document.getElementById(`doc-file-${key}`);
      const toggleEl = document.getElementById(`doc-toggle-${key}`);
      const commentBoxEl = document.getElementById(`doc-comment-box-${key}`);

      if (rowEl) {
          rowEl.classList.remove('status-empty', 'status-uploaded', 'status-commented');
          rowEl.classList.add(`status-${status}`);
      }
      if (iconEl) iconEl.innerHTML = statusMeta.icon;
      if (labelEl) labelEl.innerText = statusMeta.label;
      if (fileEl) fileEl.innerText = doc.fileName || '';
      if (commentBoxEl) commentBoxEl.style.display = doc.showComment ? 'block' : 'none';
      if (toggleEl) toggleEl.innerText = doc.showComment ? 'Masquer le commentaire' : "Je n'ai pas ce document";

      updateTrustDashboardCounters();
  }

  function updateTrustDashboardCounters() {
      const uploaded = verificationDocsState.filter(doc => getDocStatus(doc) === 'uploaded').length;
      const commented = verificationDocsState.filter(doc => getDocStatus(doc) === 'commented').length;
      const pending = verificationDocsState.filter(doc => getDocStatus(doc) === 'empty').length;

      const uploadedEl = document.getElementById('trust-uploaded');
      const commentedEl = document.getElementById('trust-commented');
      const pendingEl = document.getElementById('trust-pending');
      if (uploadedEl) uploadedEl.innerText = String(uploaded);
      if (commentedEl) commentedEl.innerText = String(commented);
      if (pendingEl) pendingEl.innerText = String(pending);
  }

  window.handleDocFileUpload = function(key, inputEl) {
      const doc = getDocByKey(key);
      if (!doc || !inputEl) return;
      doc.fileName = inputEl.files && inputEl.files[0] ? inputEl.files[0].name : '';
      const asset = getCurrentAsset();
      if (asset) asset.verificationDocs = cloneDeep(verificationDocsState);
      updateDocRowUI(key);
  }

  window.toggleDocComment = function(key) {
      const doc = getDocByKey(key);
      if (!doc) return;
      doc.showComment = !doc.showComment;
      const asset = getCurrentAsset();
      if (asset) asset.verificationDocs = cloneDeep(verificationDocsState);
      updateDocRowUI(key);
  }

  window.updateDocComment = function(key, value) {
      const doc = getDocByKey(key);
      if (!doc) return;
      doc.comment = value;
      const asset = getCurrentAsset();
      if (asset) asset.verificationDocs = cloneDeep(verificationDocsState);
      updateDocRowUI(key);
  }

  window.addLedgerRow = function(category, preset = {}) {
      const container = document.getElementById(`list-${category}`);
      const rowId = Date.now();
      const safeLabel = String(preset.label || '').replace(/"/g, '&quot;');
      const safeAmount = String(preset.amount || '').replace(/"/g, '&quot;');
      
      const rowHTML = `
          <div class="cost-row" id="row-${rowId}">
              <div class="form-group label-col">
                  <input type="text" value="${safeLabel}" placeholder="${category === 'travaux' ? 'Ex: Rénovation toiture' : 'Ex: Frais de courtage'}">
              </div>
              <div class="form-group amount-col">
                  <input type="number" class="cost-input" data-category="${category}" value="${safeAmount}" placeholder="Montant (€)" oninput="updateLedgerTotals()">
              </div>
              <label class="file-upload-btn" title="Ajouter un justificatif">
                  ${icons.paperclip} <span>Justificatif</span>
                  <input type="file">
              </label>
              <button class="icon-btn btn-remove" onclick="removeLedgerRow('row-${rowId}')" title="Supprimer la ligne">
                  ${icons.trash}
              </button>
          </div>
      `;
      container.insertAdjacentHTML('beforeend', rowHTML);
  }

  window.removeLedgerRow = function(rowId) {
      const row = document.getElementById(rowId);
      if(row) {
          row.remove();
          window.updateLedgerTotals();
      }
  }

  const formStructure = [
    { title: "Présentation", fullName: "Fiche présentation du projet", subSteps: 4 }, 
    { title: "Finances", fullName: "Plan de Dépenses", subSteps: 5 }, // Renommé 
    { title: "Projections", fullName: "Projections de financement", subSteps: 2 },
    { title: "Signature", fullName: "Signature des contrats", subSteps: 2 }
  ];

  const stepTemplates = [
    // --- 1.1 Présentation du projet ---
    `
    <div class="form-grid">
      <div class="form-group"><label>Nom du projet</label><input type="text" placeholder="Ex: Résidence Les Oliviers"></div>
      <div class="form-group"><label>État d'avancement actuel</label>
        <select><option>En recherche de financement</option><option>Sous compromis</option><option>Achat acté</option><option>Travaux à démarrer</option><option>Travaux en cours</option></select>
      </div>
    </div>
    <div class="form-grid">
      <div class="form-group"><label>Type de bien</label>
        <select><option>Appartement</option><option>Maison</option><option>Immeuble</option><option>Local commercial</option><option>Terrain</option><option>Autre</option></select>
      </div>
      <div class="form-group"><label>Type d'opération</label>
        <select><option>Achat-revente</option><option>Investissement locatif</option><option>Promotion immobilière</option><option>Marchand de biens</option></select>
      </div>
    </div>
    <div class="form-grid full">
      <div class="form-group"><label>Brève description du projet (Pitch)</label><textarea rows="2" maxlength="150" placeholder="Pitch clair et concis (Max 150 caractères)..."></textarea></div>
    </div>
    <h3 class="form-section-title">Valorisation et Experts</h3>
    <div class="form-grid">
      <div class="form-group"><label>Valeur estimée avant travaux (€)</label><input type="number" id="valBefore" placeholder="0.00" oninput="calculateEquity()"></div>
      <div class="form-group"><label>Valeur estimée après travaux (€)</label><input type="number" id="valAfter" placeholder="0.00" oninput="calculateEquity()"></div>
    </div>
    <div class="form-grid full" id="equity-container" style="display: none; padding: 12px 16px; border-radius: 8px; border: 1px solid; margin-top: -10px; margin-bottom: 20px;">
      <span style="font-weight: 600; font-size: 14px;" id="equity-result"></span>
    </div>
    <div class="form-grid">
      <div class="form-group"><label>Expert immobilier (Nom/Cabinet)</label><input type="text" placeholder="Ex: Cabinet Dupont"></div>
      <div class="form-group"><label>Date de l'expertise</label><input type="date"></div>
    </div>
    <div class="form-grid">
      <div class="form-group"><label>Durée estimée du projet (en mois)</label><input type="number" placeholder="Ex: 12"></div>
    </div>
    <h3 class="form-section-title">Stratégie et Marché</h3>
    <div class="form-grid">
      <div class="form-group"><label>Stratégie d'exploitation</label>
        <select><option>Location saisonnière (Airbnb)</option><option>Location classique</option><option>Vente (Revente)</option><option>Colocation</option></select>
      </div>
      <div class="form-group"><label>Segment de marché visé</label><input type="text" placeholder="Ex: Étudiants, Jeunes actifs, Familles"></div>
    </div>
    <div class="form-grid">
      <div class="form-group"><label>Revenus projetés (€)</label><input type="number" placeholder="0.00"></div>
      <div class="form-group"><label>Période</label><select><option>Mensuel</option><option>Annuel</option></select></div>
    </div>
    <div class="form-grid full">
      <div class="form-group"><label>Informations complémentaires</label><textarea rows="3" placeholder="Y a-t-il d'autres détails importants que nos analystes devraient connaître ?"></textarea></div>
    </div>
    `,

    // --- 1.2 La localisation ---
    `
    <h3 class="form-section-title" style="margin-top: 0;">Adresse et Coordonnées</h3>
    <div class="form-grid full">
      <div class="form-group">
        <label>Adresse exacte du bien</label>
        <input id="project-main-address" type="text" placeholder="Recherche d'adresse automatisée...">
        <span style="font-size: 12px; color: var(--gray-text); margin-top: 6px;">Vous pourrez ajouter d'autres adresses dans les prochaines étapes (Hub des adresses).</span>
      </div>
    </div>
    <div class="form-grid">
      <div class="form-group"><label>Code Postal</label><input type="text" placeholder="Ex: 75004"></div>
      <div class="form-group"><label>Ville</label><input type="text" placeholder="Ex: Paris"></div>
    </div>
    <div class="form-grid">
      <div class="form-group"><label>Quartier / Secteur</label><input type="text" placeholder="Ex: Le Marais"></div>
      <div class="form-group"><label>Typologie de la zone</label>
        <select>
          <option>Hyper-centre</option><option>Périphérie</option><option>Zone rurale</option><option>Quartier d'affaires</option><option>Zone touristique</option><option>Quartier étudiant</option>
        </select>
      </div>
    </div>
    <h3 class="form-section-title">Environnement et Atouts</h3>
    <div class="form-grid full">
      <div class="form-group">
        <label>Accès aux transports</label>
        <div class="checkbox-grid">
          <label><input type="checkbox"> Métro</label><label><input type="checkbox"> Tramway</label><label><input type="checkbox"> Bus</label>
          <label><input type="checkbox"> Gare SNCF</label><label><input type="checkbox"> Aéroport</label><label><input type="checkbox"> Axes autoroutiers</label>
        </div>
      </div>
    </div>
    <div class="form-grid full">
      <div class="form-group">
        <label>Commodités à proximité</label>
        <div class="checkbox-grid">
          <label><input type="checkbox"> Écoles/Universités</label><label><input type="checkbox"> Commerces de proximité</label><label><input type="checkbox"> Supermarchés</label>
          <label><input type="checkbox"> Hôpitaux/Cliniques</label><label><input type="checkbox"> Parcs/Espaces verts</label>
        </div>
      </div>
    </div>
    <div class="form-grid full">
      <div class="form-group">
        <label>Atouts stratégiques de l'emplacement</label>
        <textarea rows="3" maxlength="300" placeholder="Pourquoi cet emplacement est-il idéal pour votre projet ?"></textarea>
      </div>
    </div>
    `,

    // --- 1.3 Le porteur de projet ---
    `
    <h3 class="form-section-title" style="margin-top: 0;">Identité et Structure</h3>
    <div class="form-grid">
      <div class="form-group"><label>Structure du porteur</label>
        <select>
          <option>Indépendant / Personne physique</option>
          <option>Société (SAS, SARL, SCI, etc.)</option>
        </select>
      </div>
      <div class="form-group"><label>Nom de la société / Nom du porteur</label><input type="text" placeholder="Ex: Jean Dupont ou SCI Horizon"></div>
    </div>
    <div class="form-grid full">
      <div class="form-group"><label>Lien vers le profil LinkedIn ou site web</label><input type="url" placeholder="https://www.linkedin.com/in/... ou https://votresite.com"></div>
    </div>
    <h3 class="form-section-title">Expérience et Track Record</h3>
    <div class="form-grid">
      <div class="form-group"><label>Années d'expérience en immobilier</label><input type="number" placeholder="Ex: 5"></div>
      <div class="form-group"><label>Cœur d'expertise</label>
        <select>
          <option>Marchand de biens</option>
          <option>Promoteur immobilier</option>
          <option>Rénovation de l'ancien</option>
          <option>Gestion locative</option>
          <option>Autre</option>
        </select>
      </div>
    </div>
    <div class="form-grid">
      <div class="form-group"><label>Nombre de projets immobiliers réalisés</label><input type="number" placeholder="Ex: 12"></div>
      <div class="form-group"><label>Volume d'affaires historique (€)</label><input type="number" placeholder="Ex: 5000000"></div>
    </div>
    <div class="form-grid">
      <div class="form-group"><label>Expérience dans la zone géographique du projet</label>
        <select>
          <option>Première opération dans ce secteur</option>
          <option>Déjà réalisé 1 à 3 projets ici</option>
          <option>Expert local (plus de 3 projets)</option>
        </select>
      </div>
      <div class="form-group"><label>Agréments, diplômes ou certifications</label><input type="text" placeholder="Ex: Carte T, Diplôme d'Architecte..."></div>
    </div>
    <h3 class="form-section-title">Vision et Compléments</h3>
    <div class="form-grid full">
      <div class="form-group">
        <label>Présentation synthétique de l'équipe</label>
        <textarea rows="2" maxlength="300" placeholder="En quelques phrases, qui êtes-vous et quelle est votre vision ? (Max 300 caractères)"></textarea>
      </div>
    </div>
    <div class="form-grid full">
      <div class="form-group">
        <label>Informations complémentaires</label>
        <textarea rows="3" placeholder="Y a-t-il d'autres détails sur votre parcours que nous devrions connaître ? (Prix d'architecture, projets complexes...)"></textarea>
      </div>
    </div>
    `,

    // --- 1.4 La structuration financière ---
    `
    <h3 class="form-section-title" style="margin-top: 0;">Demande de Financement</h3>
    <div class="form-grid">
      <div class="form-group">
        <label>Montant total du financement recherché (€)</label>
        <input type="number" placeholder="Ex: 500000">
      </div>
    </div>
    <h3 class="form-section-title">Rentabilité et Objectifs</h3>
    <div class="form-grid">
      <div class="form-group">
        <label>Marge brute prévisionnelle (%)</label>
        <input type="number" step="0.1" placeholder="Ex: 20">
      </div>
      <div class="form-group">
        <label>Rentabilité nette cible pour l'investisseur (% annuelle)</label>
        <input type="number" step="0.1" placeholder="Ex: 8.5">
      </div>
    </div>
    <div class="form-grid full">
      <div class="form-group">
        <label>Justification du rendement</label>
        <textarea rows="2" maxlength="300" placeholder="Sur quels éléments basez-vous cette rentabilité ? (Ex: Rendement locatif sécurisé, comparables de ventes récentes...)"></textarea>
      </div>
    </div>
    <h3 class="form-section-title">État d'Avancement</h3>
    <div class="form-grid full">
      <div class="form-group">
        <label>Stratégie de commercialisation</label>
        <div class="checkbox-grid">
          <label><input type="checkbox"> Vente sur plan (VEFA)</label>
          <label><input type="checkbox"> Agences immobilières locales</label>
          <label><input type="checkbox"> Marketing digital ciblé</label>
          <label><input type="checkbox"> Vente à la découpe</label>
          <label><input type="checkbox"> Pré-commercialisation réseau privé</label>
        </div>
      </div>
    </div>
    <div class="form-grid full">
      <div class="form-group">
        <label>État du dossier financier</label>
        <div class="checkbox-grid">
          <label><input type="checkbox"> Étude de marché réalisée</label>
          <label><input type="checkbox"> Prévisionnel financier détaillé disponible</label>
          <label><input type="checkbox"> Devis de travaux validés</label>
          <label><input type="checkbox"> Permis de construire purgé</label>
        </div>
      </div>
    </div>
    <div class="form-grid full">
      <div class="form-group">
        <label>Informations complémentaires</label>
        <textarea rows="3" placeholder="Y a-t-il d'autres détails financiers importants (coûts spécifiques, subventions, etc.) ?"></textarea>
      </div>
    </div>
    `,
    
    // --- 2.0 Hub des adresses ---
    `
    <p style="color: var(--gray-text); margin-bottom: 16px;">
      Gérez ici toutes les adresses du projet. Ouvrez un actif pour compléter son sous-parcours financier.
    </p>
    <div class="hub-toolbar">
      <div class="lots-meta">Hub des adresses <span id="hub-count">0 adresse</span></div>
      <button class="action-btn-text" type="button" onclick="addNewAsset()">${icons.plus} Ajouter une autre adresse</button>
    </div>
    <div class="hub-list" id="hub-list"></div>
    `,

    // --- 2.1 Détails de l'Actif et Calendrier ---
    `
    <div class="readonly-header">
        ${icons.pin}
        <div>
            <h3>27650 Louye, France</h3>
            <span style="color: var(--gray-text); font-size: 13px;">Adresse validée à l'étape 1.2</span>
        </div>
    </div>
    <h3 class="form-section-title" style="margin-top: 0;">Acquisition et Calendrier</h3>
    <div class="form-grid full">
      <div class="form-group">
        <label>Êtes-vous déjà propriétaire de ce bien ? (Refinancement)</label>
        <div class="checkbox-grid" style="grid-template-columns: max-content max-content;">
           <label><input type="radio" name="proprio" id="proprio-oui" value="oui" onchange="toggleOwnershipDate()"> Oui</label>
           <label><input type="radio" name="proprio" id="proprio-non" value="non" onchange="toggleOwnershipDate()" checked> Non</label>
        </div>
      </div>
    </div>
    <div class="form-grid" id="date-signature-container">
      <div class="form-group">
        <label>Date projetée pour la signature de l'acte authentique</label>
        <input type="date">
      </div>
    </div>
    <div class="form-grid">
      <div class="form-group">
        <label>Nombre de lots pour cette adresse</label>
        <input type="number" placeholder="Ex: 4">
      </div>
    </div>
    <h3 class="form-section-title">Travaux et Rénovation</h3>
    <div class="form-grid full">
      <div class="form-group">
        <label>Des travaux sont-ils nécessaires ?</label>
        <div class="checkbox-grid" style="grid-template-columns: max-content max-content;">
           <label><input type="radio" name="renov" id="renov-oui" value="oui" onchange="toggleRenovationDuration()"> Oui</label>
           <label><input type="radio" name="renov" id="renov-non" value="non" onchange="toggleRenovationDuration()" checked> Non</label>
        </div>
      </div>
    </div>
    <div class="form-grid" id="renov-duration-container" style="display: none;">
      <div class="form-group">
        <label>Durée projetée des travaux (en mois)</label>
        <input type="number" placeholder="Ex: 6">
        <span style="font-size: 12px; color: var(--gray-text); margin-top: 4px;">À différencier de la durée totale du projet.</span>
      </div>
    </div>
    `,
    
    // --- 2.2 Plan de Dépenses ---
    `
    <p style="color: var(--gray-text); margin-bottom: 24px;">Saisissez vos postes de dépenses. Attachez les devis ou factures correspondants via le bouton justificatif.</p>

    <details class="ledger-card" open>
      <summary>
          <div class="ledger-title">${icons.building} Coûts d'Acquisition</div>
          <div class="ledger-subtotal" id="subtotal-acq">0 €</div>
      </summary>
      <div class="ledger-content">
          <div class="cost-row">
              <div class="label-col">Prix d'acquisition (Net vendeur)</div>
              <div class="form-group amount-col">
                  <input type="number" class="cost-input" data-category="acq" data-id="acq-price" placeholder="Montant (€)" oninput="calculateNotaryFees()">
              </div>
              <label class="file-upload-btn">${icons.paperclip} <span>Justificatif</span><input type="file"></label>
          </div>
          <div class="cost-row">
              <div class="label-col">Frais de notaire (Auto-calculés à ~7.5%)</div>
              <div class="form-group amount-col">
                  <input type="number" class="cost-input" data-category="acq" data-id="acq-notary" placeholder="Montant (€)" oninput="updateLedgerTotals()">
              </div>
              <label class="file-upload-btn">${icons.paperclip} <span>Justificatif</span><input type="file"></label>
          </div>
          <div class="cost-row">
              <div class="label-col">Frais d'agence (Optionnel)</div>
              <div class="form-group amount-col">
                  <input type="number" class="cost-input" data-category="acq" placeholder="Montant (€)" oninput="updateLedgerTotals()">
              </div>
              <label class="file-upload-btn">${icons.paperclip} <span>Justificatif</span><input type="file"></label>
          </div>
      </div>
    </details>

    <details class="ledger-card">
      <summary>
          <div class="ledger-title">${icons.tool} Budget Travaux</div>
          <div class="ledger-subtotal" id="subtotal-travaux">0 €</div>
      </summary>
      <div class="ledger-content">
          <div id="list-travaux"></div>
          <button class="action-btn-text" onclick="addLedgerRow('travaux')" style="margin-top: 10px;">${icons.plus} Ajouter un poste de travaux</button>
      </div>
    </details>

    <details class="ledger-card">
      <summary>
          <div class="ledger-title">${icons.ruler} Honoraires & Expertise</div>
          <div class="ledger-subtotal" id="subtotal-expert">0 €</div>
      </summary>
      <div class="ledger-content">
          <div class="cost-row">
              <div class="label-col">Architecte</div>
              <div class="form-group amount-col"><input type="number" class="cost-input" data-category="expert" placeholder="Montant (€)" oninput="updateLedgerTotals()"></div>
              <label class="file-upload-btn">${icons.paperclip} <span>Justificatif</span><input type="file"></label>
          </div>
          <div class="cost-row">
              <div class="label-col">Bureau d'étude (Structure/Thermique)</div>
              <div class="form-group amount-col"><input type="number" class="cost-input" data-category="expert" placeholder="Montant (€)" oninput="updateLedgerTotals()"></div>
              <label class="file-upload-btn">${icons.paperclip} <span>Justificatif</span><input type="file"></label>
          </div>
          <div class="cost-row">
              <div class="label-col">Géomètre / Expert</div>
              <div class="form-group amount-col"><input type="number" class="cost-input" data-category="expert" placeholder="Montant (€)" oninput="updateLedgerTotals()"></div>
              <label class="file-upload-btn">${icons.paperclip} <span>Justificatif</span><input type="file"></label>
          </div>
      </div>
    </details>

    <details class="ledger-card">
      <summary>
          <div class="ledger-title">${icons.plus} Dépenses Supplémentaires</div>
          <div class="ledger-subtotal" id="subtotal-custom">0 €</div>
      </summary>
      <div class="ledger-content">
          <div id="list-custom"></div>
          <button class="action-btn-text" onclick="addLedgerRow('custom')" style="margin-top: 10px;">${icons.plus} Ajouter une autre dépense</button>
      </div>
    </details>
    `,
    
    // --- 2.3 Plan de Revente et Revenus par Lot ---
    `
    <p style="color: var(--gray-text); margin-bottom: 20px;">
      Configurez chaque lot vendu pour piloter vos recettes prévisionnelles en temps réel.
    </p>
    <div class="lots-toolbar">
      <div class="lots-meta">Lot Gallery <span id="lot-count">0 lot</span></div>
      <button class="action-btn-text" type="button" onclick="addLotCard()">${icons.plus} Ajouter un lot</button>
    </div>
    <div id="lot-gallery" class="lot-grid"></div>
    `,

    // --- 2.4 Vérification et Documents Justificatifs ---
    `
    <p style="color: var(--gray-text); margin-bottom: 14px;">
      Vérifiez les données financières avec les pièces justificatives attendues.
    </p>
    <div class="trust-dashboard">
      <div class="trust-kpi">
        <div class="trust-kpi-label">Documents chargés</div>
        <div class="trust-kpi-value" id="trust-uploaded">0</div>
      </div>
      <div class="trust-kpi">
        <div class="trust-kpi-label">Justifications à revoir</div>
        <div class="trust-kpi-value" id="trust-commented">0</div>
      </div>
      <div class="trust-kpi">
        <div class="trust-kpi-label">Documents manquants</div>
        <div class="trust-kpi-value" id="trust-pending">0</div>
      </div>
    </div>
    <section class="doc-group">
      <h3 class="doc-group-title">Documents requis</h3>
      <div class="doc-list" id="verification-required-list"></div>
    </section>
    <section class="doc-group">
      <h3 class="doc-group-title">Documents optionnels</h3>
      <div class="doc-list" id="verification-optional-list"></div>
    </section>
    `,
    
    // --- 3.1 Engagement du Porteur (Contribution) ---
    `
    <div class="projection-power-card">
      <div class="projection-power-label">Engagement du porteur</div>
      <div class="projection-power-amount" id="contribution-amount">0 €</div>
      <div class="projection-power-meta" id="contribution-pct">0% du coût total agrégé</div>
      <div class="power-slider-wrap">
        <input id="contribution-slider" class="power-slider" type="range" min="0" max="100" step="1" value="20" oninput="updateContributionPct(this.value)">
        <div class="power-slider-ends">
          <span>Minimum</span>
          <span>Auto-financement</span>
        </div>
      </div>
    </div>
    <div class="warning-alert" id="projection-warning">
      ${icons.alert}
      <div>
        Ajustez votre apport pour optimiser la rentabilité de l'opération.
        <div style="font-weight: 500; margin-top: 4px;">Indicateur revente / (coût - apport): <span id="projection-warning-ratio">0.00</span></div>
      </div>
    </div>
    <div class="form-grid full">
      <div class="form-group">
        <label>Preuve des fonds propres</label>
        <label class="dropzone">
          Déposez votre document ici ou cliquez pour sélectionner un fichier.
          <input type="file" style="display:none;" onchange="handleProofUpload(this)">
        </label>
        <span id="proof-file-name" style="font-size:12px; color: var(--gray-text); margin-top: 6px;"></span>
      </div>
    </div>
    `,

    // --- 3.2 Simulation de Financement (Projections) ---
    `
    <div class="form-grid">
      <div class="form-group">
        <label>Taux d'intérêt</label>
        <input type="text" value="11% / an" disabled>
      </div>
      <div class="form-group">
        <label>Durée d'emprunt (mois)</label>
        <input id="projection-duration" type="number" min="1" step="1" value="12" oninput="updateProjectionDuration(this.value)">
      </div>
    </div>
    <div style="background:#f8fafc; border:1px solid var(--gray-light); border-radius:8px; padding:10px 12px; color:var(--gray-text); font-size:13px; margin-bottom:12px;">
      Ces modalités sont susceptibles d'évoluer suite à la phase d'analyse.
    </div>
    <div class="receipt-card">
      <div class="receipt-row"><span class="receipt-key">Coûts de l'opération</span><span class="receipt-val" id="sim-total-costs">0 €</span></div>
      <div class="receipt-row"><span class="receipt-key">Apport (soustrait)</span><span class="receipt-val gold" id="sim-apport">0 €</span></div>
      <div class="receipt-row"><span class="receipt-key">Frais de collecte (6%)</span><span class="receipt-val" id="sim-fee">0 €</span></div>
      <div class="receipt-row"><span class="receipt-key">Séquestre d'intérêts</span><span class="receipt-val" id="sim-interest">0 €</span></div>
      <div class="receipt-row"><span class="receipt-key">Total Collecte</span><span class="receipt-val" id="sim-collecte">0 €</span></div>
    </div>
    <div class="final-payout">
      <div class="final-payout-title">Montant qui vous sera reversé</div>
      <div class="final-payout-value" id="sim-payout">0 €</div>
    </div>
    `,
    
    // --- 4.1 Signature ---
    `<div class="form-grid full"><div class="form-group"><label>Téléchargement des documents</label><input type="file" multiple style="padding: 20px; border: 2px dashed var(--input-border);"></div></div>`,
    `<div class="form-grid full"><div class="form-group" style="flex-direction: row; align-items: center; gap: 10px; background: #fafafa; padding: 20px; border-radius: 8px; border: 1px solid var(--input-border);"><input type="checkbox" id="consent" style="width: 20px; height: 20px;"><label for="consent" style="margin: 0; font-weight: normal;">Je certifie l'exactitude des informations fournies.</label></div></div>`
  ];

  const flatSteps = [];
  let globalStepIndex = 0;

  const macroNavEl = document.getElementById('macro-nav');
  const microNavEl = document.querySelector('.micro-nav');
  const microTabsEl = document.getElementById('micro-tabs');
  const microStatusEl = document.getElementById('micro-status-text');
  const stepTitleEl = document.getElementById('step-title');
  const dynamicFieldsEl = document.getElementById('dynamic-fields');
  const btnPrev = document.getElementById('btn-prev');
  const btnNext = document.getElementById('btn-next');
  const floatingTotalContainer = document.getElementById('floating-total-container');

  function jumpToMacroStep(macroIdx) {
    saveProjectLevelData();
    saveAssetStepData();
    if (dossierSubmitted && macroIdx > 2) return;
    const targetIndex = flatSteps.findIndex(step => step.macroIndex === macroIdx);
    if (targetIndex >= 0) {
      globalStepIndex = targetIndex;
      selectedAssetIndex = null;
      updateUI();
    }
  }

  function initialize() {
    formStructure.forEach((macro, mIdx) => {
      for (let i = 0; i < macro.subSteps; i++) {
        flatSteps.push({ macroIndex: mIdx, microIndex: i, macroData: macro });
      }
      const div = document.createElement('div');
      div.className = 'macro-step';
      div.id = `macro-step-${mIdx}`;
      div.innerHTML = `<div class="macro-step-icon">${mIdx + 1}</div><span>${macro.title}</span>`;
      div.addEventListener('click', () => jumpToMacroStep(mIdx));
      macroNavEl.appendChild(div);
    });
    updateUI();
  }

  function updateUI() {
    if (dossierSubmitted && globalStepIndex > DOSSIER_SUBMIT_STEP_INDEX) {
      globalStepIndex = DOSSIER_SUBMIT_STEP_INDEX;
    }
    if (globalStepIndex >= 5 && globalStepIndex <= 8 && (selectedAssetIndex === null || !assetsState[selectedAssetIndex])) {
      globalStepIndex = 4;
    }

    const { macroIndex, microIndex, macroData } = flatSteps[globalStepIndex];

    formStructure.forEach((_, idx) => {
      const el = document.getElementById(`macro-step-${idx}`);
      const iconEl = el.querySelector('.macro-step-icon');
      el.className = 'macro-step'; 
      if (idx < macroIndex) {
        el.classList.add('completed');
        iconEl.innerHTML = icons.check;
      } else if (idx === macroIndex) {
        el.classList.add('active');
        iconEl.innerHTML = idx + 1;
      } else {
        iconEl.innerHTML = idx + 1;
      }
    });

    microTabsEl.innerHTML = '';
    for (let i = 0; i < macroData.subSteps; i++) {
      const tab = document.createElement('div');
      tab.className = 'micro-tab';
      if (i < microIndex) tab.classList.add('completed');
      if (i === microIndex) tab.classList.add('active');
      microTabsEl.appendChild(tab);
    }
    
    microStatusEl.innerText = `Étape ${microIndex + 1} sur ${macroData.subSteps}`;
    if (microNavEl) microNavEl.style.display = globalStepIndex === 4 ? 'none' : 'block';
    
    if (globalStepIndex === 0) {
       stepTitleEl.innerText = "Fiche présentation du projet";
       document.getElementById('step-desc').innerText = "Informations générales sur l'actif et l'opération ciblée.";
    } else if (globalStepIndex === 1) {
       stepTitleEl.innerText = "Localisation du projet";
       document.getElementById('step-desc').innerText = "Détails géographiques et atouts stratégiques de l'emplacement.";
    } else if (globalStepIndex === 2) {
       stepTitleEl.innerText = "Le porteur de projet";
       document.getElementById('step-desc').innerText = "Structure, historique et expérience de l'équipe porteuse.";
    } else if (globalStepIndex === 3) {
       stepTitleEl.innerText = "La structuration financière";
       document.getElementById('step-desc').innerText = "Objectifs de rentabilité et état d'avancement du dossier.";
    } else if (globalStepIndex === 4) {
       stepTitleEl.innerText = "Hub des adresses";
       document.getElementById('step-desc').innerText = "Tableau de bord des adresses du projet et progression par actif.";
    } else if (globalStepIndex === 5) {
       stepTitleEl.innerText = "Détails de l'Actif et Calendrier";
       document.getElementById('step-desc').innerText = "Spécificités techniques du bien et rétroplanning de l'opération.";
    } else if (globalStepIndex === 6) {
       stepTitleEl.innerText = "Plan de Dépenses";
       document.getElementById('step-desc').innerText = "Détail du budget nécessaire à la réalisation du projet.";
    } else if (globalStepIndex === 7) {
       stepTitleEl.innerText = "Plan de Revente et Revenus par Lot";
       document.getElementById('step-desc').innerText = "Inflow du projet: lots, prix projetés et bilan prévisionnel instantané.";
    } else if (globalStepIndex === 8) {
       stepTitleEl.innerText = "Vérification et Documents Justificatifs";
       document.getElementById('step-desc').innerText = "Validation formelle des données financières via une checklist documentaire.";
    } else if (globalStepIndex === 9) {
       stepTitleEl.innerText = "Engagement du Porteur (Contribution)";
       document.getElementById('step-desc').innerText = "Définissez l'apport pour calibrer la structure de financement.";
    } else if (globalStepIndex === 10) {
       stepTitleEl.innerText = "Simulation de Financement (Projections)";
       document.getElementById('step-desc').innerText = "Visualisez la collecte, les frais et le montant net reversé.";
    } else {
       stepTitleEl.innerText = macroData.fullName;
       document.getElementById('step-desc').innerText = "Veuillez remplir les champs de cette section.";
    }

    if (globalStepIndex >= 5 && globalStepIndex <= 8) {
      const asset = getCurrentAsset();
      if (asset) stepTitleEl.innerText = `${stepTitleEl.innerText} · ${asset.label}`;
    }
    
    dynamicFieldsEl.innerHTML = stepTemplates[globalStepIndex];
    dynamicFieldsEl.scrollTop = 0;
    
    // Affichage conditionnel de la barre des totaux
    if (globalStepIndex === 4) {
        floatingTotalContainer.innerHTML = '';
        if (assetsState.length === 0) {
            assetsState.push(createEmptyAsset(projectPrimaryAddress));
            lastSyncedPrimaryAddress = projectPrimaryAddress || lastSyncedPrimaryAddress;
        }
        syncPrimaryAddressToFirstAsset();
        updateHubCards();
    } else if (globalStepIndex === 6) {
        floatingTotalContainer.innerHTML = `
            <div class="floating-total-bar">
                <span class="floating-total-label">Total des coûts du projet (Capex)</span>
                <span class="floating-total-value" id="ledger-grand-total">0 €</span>
            </div>
        `;
        const asset = getCurrentAsset();
        if (asset) {
            applyStoredFormValues(asset.costsFields);
            const restoreRows = (category, rows) => {
                const list = document.getElementById(`list-${category}`);
                if (!list) return;
                list.innerHTML = '';
                (rows || []).forEach(row => addLedgerRow(category, row));
            };
            restoreRows('travaux', asset.costRows?.travaux);
            restoreRows('custom', asset.costRows?.custom);
            if ((asset.costRows?.travaux || []).length === 0) addLedgerRow('travaux');
            window.updateLedgerTotals();
        }
    } else if (globalStepIndex === 7) {
        floatingTotalContainer.innerHTML = `
            <div class="floating-total-bar">
                <div class="floating-total-block">
                    <span class="floating-total-label">Total des recettes</span>
                    <span class="floating-total-value" id="recettes-grand-total">0 €</span>
                </div>
                <div class="floating-total-separator"></div>
                <div class="floating-total-block">
                    <span class="floating-total-label">Bilan prévisionnel (Recettes - Coûts)</span>
                    <span class="floating-total-value alt" id="projected-profit">0 €</span>
                </div>
            </div>
        `;
        const asset = getCurrentAsset();
        lotsState = cloneDeep(asset?.lots?.length ? asset.lots : [createEmptyLot()]);
        renderLots();
        window.lastLedgerGrandTotal = asset?.costTotal || 0;
        updateRecettesSummaryBar();
    } else if (globalStepIndex === 8) {
        floatingTotalContainer.innerHTML = '';
        renderVerificationChecklist();
    } else {
        floatingTotalContainer.innerHTML = '';
    }

    renderSubmissionNotice();

    if (globalStepIndex === 1) {
        const addressInput = document.getElementById('project-main-address');
        if (addressInput && projectPrimaryAddress) addressInput.value = projectPrimaryAddress;
    }

    if (globalStepIndex === 5) {
        const asset = getCurrentAsset();
        if (asset) {
          const addrTitle = dynamicFieldsEl.querySelector('.readonly-header h3');
          if (addrTitle) addrTitle.innerText = asset.label;
          applyStoredFormValues(asset.detailsFields);
          toggleOwnershipDate();
          toggleRenovationDuration();
        }
    }

    if (globalStepIndex === 9) {
        refreshContributionUI();
        refreshSimulationUI();
    } else if (globalStepIndex === 10) {
        refreshSimulationUI();
    }

    btnPrev.disabled = globalStepIndex === 0 || dossierSubmitting;
    const canAdvanceFromHub = assetsState.length > 0 && assetsState.every(asset => isAssetComplete(asset));
    if (dossierSubmitting) {
      btnNext.innerText = "Envoi en cours...";
      btnNext.disabled = true;
    } else if (dossierSubmitted && globalStepIndex === DOSSIER_SUBMIT_STEP_INDEX) {
      btnNext.innerText = "Dossier envoyé";
      btnNext.disabled = true;
    } else if (globalStepIndex === 4) {
      btnNext.innerText = "Étape Suivante";
      btnNext.disabled = !canAdvanceFromHub;
    } else if (globalStepIndex === 10) {
      btnNext.innerText = "Envoyer mon dossier en analyse";
      btnNext.disabled = false;
    } else if (globalStepIndex === flatSteps.length - 1) {
      btnNext.innerText = "Soumettre le dossier";
      btnNext.disabled = false;
    } else {
      btnNext.innerText = "Étape Suivante";
      btnNext.disabled = false;
    }

    applyReadOnlyMode();
  }

  btnNext.addEventListener('click', () => {
    if (dossierSubmitting) return;
    if (dossierSubmitted && globalStepIndex === DOSSIER_SUBMIT_STEP_INDEX) return;
    saveProjectLevelData();
    saveAssetStepData();

    if (globalStepIndex === 4) {
      if (assetsState.length > 0 && assetsState.every(asset => isAssetComplete(asset))) {
        globalStepIndex = 9;
        selectedAssetIndex = null;
      }
      updateUI();
      return;
    }

    if (globalStepIndex === 8) {
      const asset = getCurrentAsset();
      if (asset) asset.completed = isAssetComplete(asset);
      globalStepIndex = 4;
      updateUI();
      return;
    }

    if (globalStepIndex === DOSSIER_SUBMIT_STEP_INDEX) {
      dossierSubmitting = true;
      updateUI();
      setTimeout(() => {
        dossierSubmitting = false;
        dossierSubmitted = true;
        globalStepIndex = DOSSIER_SUBMIT_STEP_INDEX;
        selectedAssetIndex = null;
        updateUI();
      }, 1400);
      return;
    }

    if (globalStepIndex < flatSteps.length - 1) {
      globalStepIndex++;
      updateUI();
    } else {
      alert("Dossier soumis avec succès !");
    }
  });

  btnPrev.addEventListener('click', () => {
    saveProjectLevelData();
    saveAssetStepData();
    if (globalStepIndex === 9) {
      globalStepIndex = 4;
      updateUI();
      return;
    }
    if (globalStepIndex > 0) { globalStepIndex--; updateUI(); }
  });

  initialize();
</script>

</body>
</html>
